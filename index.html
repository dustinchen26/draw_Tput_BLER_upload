<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload and Draw Total DL-BLER, UL-BLER, DL Tpt, UL Tpt</title>
    <!-- Include Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.2;
            font-size: 14px;
        }

        .upload-container {
            display: flex;
            align-items: center;
        }

        .upload-btn {
            margin-right: 10px;
        }

        .progress-label {
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <h2>Upload and Draw Total DL-BLER, UL-BLER, DL Tpt, UL Tpt</h2>

    <p style="margin: 0;">Author: Dustin_Chen, email: <a href="mailto:Dustin_Chen@compal.com"
            style="line-height: 1;">Dustin_Chen@compal.com</a> or <a href="mailto:chuhpsdustin@gmail.com"
            style="line-height: 1;">chuhpsdustin@gmail.com</a></p>
    <ul>
        <li><strong>Please upload the du_stats_XXX.txt below, then it will draw the total DL-BLER, UL-BLER, DL
                Tpt, UL Tpt</strong>
            <ul>
                <li>total DL-BLER = DL-RETX /( DL-NEWTX + DL-RETX)</li>
                <li>total UL-BLER = UL-RETX /( UL-NEWTX + UL-RETX)</li>
                <li>total EGTP DL Tpt </li>
                <li>total UL Tpt</li>
                <div class="upload-container">
                    <input type="file" id="fileInput" accept=".txt" class="upload-btn" onchange="uploadAndParse(this)">
                    <div class="progress-label" id="progressLabel">0%</div>
                    <progress id="progress" value="0" max="100"></progress>
                </div>
                <div id="plots"></div>
            </ul>
        </li>
    </ul>

    <script>
        function uploadAndParse(input) {
            var file = input.files[0];
            var progress = document.getElementById('progress');
            var progressLabel = document.getElementById('progressLabel');
            var plots = document.getElementById('plots');

            var reader = new FileReader();
            var chunkSize = 10 * 1024 * 1024; // 10MB per chunk to handle 2GB files efficiently
            var currentPosition = 0;
            var time = [];
            var dlBler = [];
            var ulBler = [];
            var dlTpt = [];
            var ulTpt = [];

            // Function to parse a chunk of data
            function parseData(chunk) {
                var inputData = chunk.trim().split('\n');

                for (var i = 0; i < inputData.length; i++) {
                    var line = inputData[i].trim();

                    // Skip empty lines
                    if (line === "") {
                        continue;
                    }

                    // Extract time
                    if (line.includes("GNB DU Statistics") && line.split(" ").length > 4) {
                        var timeParts = line.split(" ").slice(5, 9).join(" ");
                        time.push(timeParts);
                    }
                    // Extract DL-BLER
                    else if (line.startsWith("CELL-ID   CELL-DL-BANDWIDTH")) {
                        var dlParts = inputData[i + 1]?.trim().split(/\s+/);
                        if (dlParts && dlParts.length > 11) {
                            var dlNewTx = parseFloat(dlParts[10]);
                            var dlReTx = parseFloat(dlParts[11]);
                            if (!isNaN(dlNewTx) && !isNaN(dlReTx)) {
                                var bler = dlReTx / (dlNewTx + dlReTx);
                                dlBler.push(bler);
                            } else {
                                console.warn('Invalid DL-BLER data at line:', line);
                            }
                        } else {
                            console.warn('No data found after CELL-ID CELL-DL-BANDWIDTH at line:', line);
                        }
                    }
                    // Extract UL-BLER
                    else if (line.startsWith("CELL-ID   AVG-UL-PRB")) {
                        var ulParts = inputData[i + 1]?.trim().split(/\s+/);
                        if (ulParts && ulParts.length > 9) {
                            var ulNewTx = parseFloat(ulParts[8]);
                            var ulReTx = parseFloat(ulParts[9]);
                            if (!isNaN(ulNewTx) && !isNaN(ulReTx)) {
                                var bler = ulReTx / (ulNewTx + ulReTx);
                                ulBler.push(bler);
                            } else {
                                console.warn('Invalid UL-BLER data at line:', line);
                            }
                        } else {
                            console.warn('No data found after CELL-ID AVG-UL-PRB at line:', line);
                        }
                    }
                    // Extract DL Tpt and UL Tpt
                    else if (line.startsWith("EGTP DL Tpt")) {
                        var dlTptValue = parseFloat(line.split(":")[1]);
                        if (!isNaN(dlTptValue)) {
                            dlTpt.push(dlTptValue);
                        } else {
                            console.warn('Invalid DL Tpt data at line:', line);
                        }
                        var ulTptValue = parseFloat(line.split("UL Tpt")[1]);
                        if (!isNaN(ulTptValue)) {
                            ulTpt.push(ulTptValue);
                        } else {
                            console.warn('Invalid UL Tpt data at line:', line);
                        }
                    }
                }
            }

            // Function to draw the chart after reading all data
            function drawChart() {
                var trace1 = {
                    x: time,
                    y: dlBler,
                    mode: 'lines+markers',
                    name: 'DL-BLER',
                    yaxis: 'y1',
                    line: {
                        color: 'blue'
                    }
                };

                var trace2 = {
                    x: time,
                    y: ulBler,
                    mode: 'lines+markers',
                    name: 'UL-BLER',
                    yaxis: 'y1',
                    line: {
                        color: 'green'
                    }
                };

                var trace3 = {
                    x: time,
                    y: dlTpt,
                    mode: 'lines+markers',
                    name: 'DL Tpt',
                    yaxis: 'y2',
                    line: {
                        color: 'orange'
                    }
                };

                var trace4 = {
                    x: time,
                    y: ulTpt,
                    mode: 'lines+markers',
                    name: 'UL Tpt',
                    yaxis: 'y2',
                    line: {
                        color: 'red'
                    }
                };

                var layout = {
                    title: 'Total DL-BLER, UL-BLER, DL Tpt, UL Tpt',
                    xaxis: {
                        title: 'Time',
                        tickangle: -45, // Rotate the X axis labels
                        automargin: true // Ensure the labels are not clipped
                    },
                    yaxis: {
                        title: 'DL/UL BLER',
                        side: 'left',
                        range: [0, 1]
                    },
                    yaxis2: {
                        title: 'Throughput',
                        side: 'right',
                        overlaying: 'y',
                        range: [0, Math.max(...dlTpt, ...ulTpt) * 1.1]
                    },
                    showlegend: true
                };

                var data = [trace1, trace2, trace3, trace4];
                Plotly.newPlot(plots, data, layout);
            }

            // Function to load a chunk of data from the file
            function loadNextChunk() {
                var chunk = file.slice(currentPosition, currentPosition + chunkSize);
                reader.readAsText(chunk);
            }

            // Handle file loading and parse each chunk
            reader.onload = function (e) {
                var chunk = e.target.result;
                parseData(chunk);
                currentPosition += chunkSize;
                if (currentPosition < file.size) {
                    loadNextChunk();
                } else {
                    drawChart();
                }

                // Update progress
                var progressValue = (currentPosition / file.size) * 100;
                progress.value = progressValue;
                progressLabel.textContent = progressValue.toFixed(2) + '%';
            };

            loadNextChunk(); // Start loading the first chunk
        }
    </script>
</body>

</html>
``
